#!/usr/bin/env bash

# Copyright (C) 2016 James Murphy
# Licensed under the GPL version 2 only

status="$(acpi 2>/dev/null)"

if [[ -z "$status" ]]; then
  # è¡¨ç¤ºæ‰¾ä¸åˆ°é›»æ± 
  fulltext="<span color='red'>âŒ ğŸ”‹</span>"
  percentleft=100
# ç•¶ç„¡é›»æ± ï¼ˆæ¡Œé¢é›»è…¦ï¼‰æ™‚ï¼Œæª¢æŸ¥ "rate information unavailable"
elif [[ "$status" == *"rate information unavailable"* ]]; then
  fulltext="ğŸ”Œ <span color='black'> |</span>"
  percentleft=100
else
  # å¦‚æœä¸€éƒ¨ç­†é›»æœ‰å¤šæ–¼ä¸€å€‹é›»æ± ï¼Œæ¯å€‹é›»æ± çš„å‰©é¤˜ç™¾åˆ†æ¯”
  # ä¿‚åˆ†åˆ¥å¯ç”¨ï¼Œä½†æ•´é«”å€å¡Šçš„ç‹€æ…‹åŒå‰©é¤˜æ™‚é–“
  # é¡¯ç¤ºå–ºç¬¬ä¸€å€‹é›»æ± çš„ç‹€æ…‹

  # è¡¨ç¤ºå·²æ’é›»
  FA_PLUG="ğŸ”Œ"

  # Parse first battery line
  first_battery=$(echo "$status" | head -n 1)
  state=$(echo "$first_battery" | awk -F': ' '{print $2}' | awk -F', ' '{print $1}')

  # Calculate average percentage across all batteries
  total_percent=0
  battery_count=0
  while IFS= read -r battery; do
    if [[ -n "$battery" ]]; then
      percent=$(echo "$battery" | grep -oP '\d+(?=%)')
      if [[ -n "$percent" ]]; then
        total_percent=$((total_percent + percent))
        battery_count=$((battery_count + 1))
      fi
    fi
  done <<<"$status"

  if [[ $battery_count -gt 0 ]]; then
    percentleft=$((total_percent / battery_count))
  else
    percentleft=0
  fi

  # é›»æ± åœ–ç¤º
  if [[ $percentleft -ge 90 ]]; then
    BATTERY_ICON="ğŸ”‹"
  elif [[ $percentleft -ge 60 ]]; then
    BATTERY_ICON="ğŸ”‹"
  elif [[ $percentleft -ge 30 ]]; then
    BATTERY_ICON="ğŸ”‹"
  elif [[ $percentleft -ge 10 ]]; then
    BATTERY_ICON="ğŸª«"
  else
    BATTERY_ICON="ğŸª«"
  fi

  fulltext=""
  timeleft=""

  if [[ "$state" == "Discharging" ]]; then
    time=$(echo "$first_battery" | awk -F', ' '{print $NF}' | awk '{print $1}')
    time=$(echo "$time" | cut -d':' -f1-2)
    timeleft=" ($time)"
    fulltext+="$BATTERY_ICON"
  elif [[ "$state" == "Full" ]]; then
    fulltext+="$FA_PLUG "
  elif [[ "$state" == "Unknown" ]]; then
    fulltext+="â“ "
  else
    fulltext+="$FA_PLUG "
  fi

  color="#ffffff"
  if [[ $percentleft -lt 10 ]]; then
    # é€€å‡ºä»£ç¢¼ 33 æœƒå°‡èƒŒæ™¯è®Šç‚ºç´…è‰²
    color="#ffaaaa"
  elif [[ $percentleft -lt 20 ]] || [[ $percentleft -lt 30 ]]; then
    color="#FF3300"
  fi

  fulltext+="<span color=\"$color\">${percentleft}%</span>"
  fulltext+="$timeleft"
fi

echo "$fulltext <span color=\"white\"> |</span>"

if [[ $percentleft -lt 10 ]]; then
  exit 33
fi
